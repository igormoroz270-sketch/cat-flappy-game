<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Space Shooter</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body {
    margin: 0;
    background: black;
    overflow: hidden;
    touch-action: none;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: radial-gradient(#000, #020824);
  }
</style>
</head>
<body>

<canvas id="game" width="360" height="640"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const tg = window.Telegram?.WebApp;
tg?.ready();
tg?.expand();

// ===== PLAYER =====
let player = {
  x: 160,
  targetX: 160,
  y: 520,
  w: 40,
  h: 40,
  hp: 5,
  damage: 1,
  fireRate: 10, // чем меньше — тем быстрее стрельба
  fireCooldown: 0,
  speed: 0.15 // плавность движения
};

// ===== GAME STATE =====
let bullets = [];
let enemies = [];
let coins = [];
let money = 0;
let gameOver = false;

// ===== TOUCH CONTROL =====
canvas.addEventListener("touchmove", e => {
  let rect = canvas.getBoundingClientRect();
  let touchX = e.touches[0].clientX - rect.left;
  player.targetX = touchX - player.w / 2;
});

canvas.addEventListener("touchstart", e => {
  let rect = canvas.getBoundingClientRect();
  let touchX = e.touches[0].clientX - rect.left;
  player.targetX = touchX - player.w / 2;
});

// ===== GAME LOOP =====
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  update();
  draw();

  if (!gameOver) requestAnimationFrame(loop);
}

// ===== UPDATE =====
function update() {
  // Smooth movement (LERP)
  player.x += (player.targetX - player.x) * player.speed;

  // Borders
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

  autoShoot();
  updateBullets();
  updateEnemies();
  updateCoins();
  spawnEnemies();
}

// ===== AUTO SHOOT =====
function autoShoot() {
  if (player.fireCooldown > 0) {
    player.fireCooldown--;
    return;
  }

  bullets.push({
    x: player.x + player.w / 2,
    y: player.y,
    speed: 8
  });

  player.fireCooldown = player.fireRate;
}

// ===== DRAW =====
function draw() {
  drawPlayer();
  bullets.forEach(drawBullet);
  enemies.forEach(drawEnemy);
  coins.forEach(drawCoin);

  ctx.fillStyle = "white";
  ctx.font = "16px Arial";
  ctx.fillText("Coins: " + money, 10, 20);
  ctx.fillText("HP: " + player.hp, 10, 40);
}

// ===== PLAYER =====
function drawPlayer() {
  ctx.fillStyle = "#00ffff";
  ctx.beginPath();
  ctx.moveTo(player.x + player.w / 2, player.y);
  ctx.lineTo(player.x, player.y + player.h);
  ctx.lineTo(player.x + player.w, player.y + player.h);
  ctx.closePath();
  ctx.fill();
}

// ===== BULLETS =====
function updateBullets() {
  for (let i = bullets.length - 1; i >= 0; i--) {
    bullets[i].y -= bullets[i].speed;
    if (bullets[i].y < 0) bullets.splice(i, 1);
  }
}

function drawBullet(b) {
  ctx.fillStyle = "yellow";
  ctx.fillRect(b.x - 2, b.y, 4, 10);
}

// ===== ENEMIES =====
function spawnEnemies() {
  if (Math.random() < 0.02) {
    let level = Math.ceil(Math.random() * 3);
    enemies.push({
      x: Math.random() * (canvas.width - 40),
      y: -40,
      w: 40,
      h: 40,
      hp: level * 2,
      maxHp: level * 2,
      level,
      speed: 1 + level
    });
  }
}

function updateEnemies() {
  for (let i = enemies.length - 1; i >= 0; i--) {
    let e = enemies[i];
    e.y += e.speed;

    // Bullet hit
    for (let j = bullets.length - 1; j >= 0; j--) {
      if (pointInRect(bullets[j], e)) {
        e.hp -= player.damage;
        bullets.splice(j, 1);

        if (e.hp <= 0) {
          spawnCoins(e);
          enemies.splice(i, 1);
          break;
        }
      }
    }

    // Player collision
    if (rectHit(player, e)) {
      player.hp--;
      enemies.splice(i, 1);
      if (player.hp <= 0) gameOver = true;
    }

    if (e.y > canvas.height) enemies.splice(i, 1);
  }
}

function drawEnemy(e) {
  ctx.fillStyle = ["#ff5555", "#ff8844", "#ff0000"][e.level - 1];
  ctx.fillRect(e.x, e.y, e.w, e.h);

  // HP bar
  ctx.fillStyle = "black";
  ctx.fillRect(e.x, e.y - 6, e.w, 4);
  ctx.fillStyle = "lime";
  ctx.fillRect(e.x, e.y - 6, (e.hp / e.maxHp) * e.w, 4);
}

// ===== COINS =====
function spawnCoins(enemy) {
  let amount = enemy.level + 1;
  for (let i = 0; i < amount; i++) {
    coins.push({
      x: enemy.x + enemy.w / 2,
      y: enemy.y,
      vy: Math.random() * 2 + 1
    });
  }
}

function updateCoins() {
  for (let i = coins.length - 1; i >= 0; i--) {
    let c = coins[i];
    c.y += c.vy;

    if (rectHit(player, { x: c.x, y: c.y, w: 10, h: 10 })) {
      money++;
      coins.splice(i, 1);
    }

    if (c.y > canvas.height) coins.splice(i, 1);
  }
}

function drawCoin(c) {
  ctx.fillStyle = "gold";
  ctx.beginPath();
  ctx.arc(c.x, c.y, 5, 0, Math.PI * 2);
  ctx.fill();
}

// ===== COLLISION =====
function pointInRect(p, r) {
  return (
    p.x > r.x &&
    p.x < r.x + r.w &&
    p.y > r.y &&
    p.y < r.y + r.h
  );
}

function rectHit(a, b) {
  return (
    a.x < b.x + b.w &&
    a.x + a.w > b.x &&
    a.y < b.y + b.h &&
    a.y + a.h > b.y
  );
}

loop();
</script>

</body>
</html>

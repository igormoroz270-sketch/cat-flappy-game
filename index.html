<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Space Shooter</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
  touch-action: none;
}
canvas {
  display: block;
  margin: 0 auto;
  background: radial-gradient(#000, #020824);
}
#shop {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.8);
  color: white;
  padding: 10px;
  border-radius: 10px;
  font-family: Arial;
  font-size: 14px;
}
button {
  margin: 4px;
}
</style>
</head>
<body>

<canvas id="game" width="360" height="640"></canvas>

<div id="shop">
  <b>SHOP</b><br>
  <button onclick="buyDamage()">+Damage (100ğŸª™)</button>
  <button onclick="buyFireRate()">+Fire Rate (150ğŸª™)</button>
  <button onclick="buyHP()">+HP (200ğŸª™)</button>
  <hr>
  <button onclick="buyStars('damage')">â­ x2 Damage</button>
  <button onclick="buyStars('fire')">â­ Turbo Fire</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const tg = window.Telegram?.WebApp;
tg?.ready();
tg?.expand();

// ===== PLAYER =====
let player = {
  x: 160, targetX: 160, y: 520,
  w: 40, h: 40,
  hp: 5, damage: 1,
  fireRate: 10, fireCooldown: 0,
  speed: 0.15
};

// ===== STATE =====
let bullets = [], enemies = [], coins = [];
let money = 0;
let gameOver = false;

// ===== WEEKLY BOSS =====
const WEEK = 7 * 24 * 60 * 60 * 1000;
let lastBossKill = localStorage.getItem("boss") || 0;
let bossAlive = Date.now() - lastBossKill > WEEK;

// ===== INPUT =====
canvas.addEventListener("touchmove", e => {
  let rect = canvas.getBoundingClientRect();
  player.targetX = e.touches[0].clientX - rect.left - player.w / 2;
});

// ===== LOOP =====
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  update();
  draw();
  requestAnimationFrame(loop);
}

// ===== UPDATE =====
function update() {
  player.x += (player.targetX - player.x) * player.speed;
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));

  autoShoot();
  updateBullets();
  updateEnemies();
  updateCoins();
  spawnEnemies();
}

// ===== AUTO SHOOT =====
function autoShoot() {
  if (player.fireCooldown-- > 0) return;
  bullets.push({ x: player.x + player.w/2, y: player.y, speed: 8 });
  player.fireCooldown = player.fireRate;
}

// ===== ENEMIES =====
function spawnEnemies() {
  if (bossAlive && !enemies.find(e => e.boss)) {
    enemies.push({
      x: 100, y: -80, w: 160, h: 80,
      hp: 100, maxHp: 100, speed: 0.5,
      boss: true
    });
  } else if (Math.random() < 0.02) {
    enemies.push({
      x: Math.random() * 320, y: -40,
      w: 40, h: 40,
      hp: 3, maxHp: 3, speed: 2
    });
  }
}

function updateEnemies() {
  enemies.forEach((e,i) => {
    e.y += e.speed;

    bullets.forEach((b,j) => {
      if (hit(b,e)) {
        e.hp -= player.damage;
        bullets.splice(j,1);
        if (e.hp <= 0) {
          if (e.boss) {
            money += 1000;
            bossAlive = false;
            localStorage.setItem("boss", Date.now());
          } else spawnCoins(e);
          enemies.splice(i,1);
        }
      }
    });
  });
}

// ===== COINS =====
function spawnCoins(e) {
  for (let i=0;i<2;i++)
    coins.push({ x:e.x+20, y:e.y, vy:2 });
}

function updateCoins() {
  coins.forEach((c,i) => {
    c.y += c.vy;
    if (rectHit(player,{x:c.x,y:c.y,w:10,h:10})) {
      money++;
      coins.splice(i,1);
    }
  });
}

// ===== DRAW =====
function draw() {
  ctx.fillStyle="#0ff";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  bullets.forEach(b=>{
    ctx.fillStyle="yellow";
    ctx.fillRect(b.x,b.y,4,10);
  });

  enemies.forEach(e=>{
    ctx.fillStyle=e.boss?"purple":"red";
    ctx.fillRect(e.x,e.y,e.w,e.h);
  });

  coins.forEach(c=>{
    ctx.fillStyle="gold";
    ctx.beginPath();
    ctx.arc(c.x,c.y,5,0,Math.PI*2);
    ctx.fill();
  });

  ctx.fillStyle="white";
  ctx.fillText("Coins: "+money,10,20);
}

// ===== SHOP (COINS) =====
function buyDamage() {
  if (money>=100) { money-=100; player.damage++; }
}
function buyFireRate() {
  if (money>=150 && player.fireRate>3) {
    money-=150; player.fireRate--;
  }
}
function buyHP() {
  if (money>=200) { money-=200; player.hp++; }
}

// ===== STARS SHOP =====
function buyStars(type) {
  if (!tg?.openInvoice) {
    alert("Stars available only in Telegram");
    return;
  }

  tg.openInvoice({
    slug: "upgrade_"+type,
    callback: status => {
      if (status === "paid") {
        if (type==="damage") player.damage*=2;
        if (type==="fire") player.fireRate=3;
      }
    }
  });
}

// ===== COLLISION =====
function hit(b,e){
  return b.x>e.x&&b.x<e.x+e.w&&b.y>e.y&&b.y<e.y+e.h;
}
function rectHit(a,b){
  return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}

loop();
</script>

</body>
</html>

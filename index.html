<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Space Shooter</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
  touch-action: none;
  font-family: Arial, sans-serif;
}
canvas {
  display: block;
  margin: 0 auto;
  background: radial-gradient(#000, #020824);
}
.menu {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 15px;
}
button {
  padding: 12px 20px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
}
.quest {
  font-size: 14px;
}
</style>
</head>
<body>

<canvas id="game" width="360" height="640"></canvas>

<!-- MAIN MENU -->
<div id="menu" class="menu">
  <h1>ğŸš€ Space Shooter</h1>
  <button onclick="startGame()">â–¶ï¸ Ğ˜Ğ³Ñ€Ğ°Ñ‚ÑŒ</button>
  <button onclick="openShop()">ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</button>
  <div id="quests"></div>
</div>

<!-- SHOP -->
<div id="shop" class="menu" style="display:none">
  <h2>ğŸ›’ ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½</h2>
  <button onclick="buyDamage()">+Damage (100ğŸª™)</button>
  <button onclick="buyFireRate()">+Fire Rate (150ğŸª™)</button>
  <button onclick="buyHP()">+HP (200ğŸª™)</button>
  <button onclick="backToMenu()">â¬… ĞĞ°Ğ·Ğ°Ğ´</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const tg = window.Telegram?.WebApp;
tg?.ready();
tg?.expand();

// ===== GAME STATE =====
let screen = "menu"; // menu | game | shop

// ===== PLAYER =====
let player = {
  x: 160, targetX: 160, y: 520,
  w: 40, h: 40,
  hp: 5, damage: 1,
  fireRate: 10, fireCooldown: 0,
  speed: 0.15
};

let bullets=[], enemies=[], coins=[];
let money = 0;

// ===== DAILY QUESTS =====
const QUESTS = [
  { id: "kill5", text: "Ğ£Ğ½Ğ¸Ñ‡Ñ‚Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ 5 Ğ²Ñ€Ğ°Ğ³Ğ¾Ğ²", goal: 5, reward: 50 },
  { id: "collect20", text: "Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ 20 Ğ¼Ğ¾Ğ½ĞµÑ‚", goal: 20, reward: 100 }
];

let daily = JSON.parse(localStorage.getItem("daily")) || {
  date: new Date().toDateString(),
  progress: { kill5: 0, collect20: 0 },
  completed: {}
};

if (daily.date !== new Date().toDateString()) {
  daily = {
    date: new Date().toDateString(),
    progress: { kill5: 0, collect20: 0 },
    completed: {}
  };
  localStorage.setItem("daily", JSON.stringify(daily));
}

renderQuests();

// ===== MENU FUNCTIONS =====
function startGame() {
  screen = "game";
  document.getElementById("menu").style.display="none";
}

function openShop() {
  screen = "shop";
  document.getElementById("menu").style.display="none";
  document.getElementById("shop").style.display="flex";
}

function backToMenu() {
  screen = "menu";
  document.getElementById("shop").style.display="none";
  document.getElementById("menu").style.display="flex";
}

// ===== INPUT =====
canvas.addEventListener("touchmove", e => {
  if (screen!=="game") return;
  let r = canvas.getBoundingClientRect();
  player.targetX = e.touches[0].clientX - r.left - player.w/2;
});

// ===== LOOP =====
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (screen==="game") {
    update();
    draw();
  }

  requestAnimationFrame(loop);
}

// ===== UPDATE =====
function update() {
  player.x += (player.targetX-player.x)*player.speed;
  player.x=Math.max(0,Math.min(canvas.width-player.w,player.x));

  autoShoot();
  updateBullets();
  updateEnemies();
  updateCoins();
  spawnEnemies();
}

// ===== AUTO SHOOT =====
function autoShoot() {
  if (player.fireCooldown-- > 0) return;
  bullets.push({ x: player.x+20, y: player.y, speed:8 });
  player.fireCooldown=player.fireRate;
}

// ===== BULLETS =====
function updateBullets() {
  bullets.forEach((b,i)=>{
    b.y-=b.speed;
    if(b.y<0) bullets.splice(i,1);
  });
}

// ===== ENEMIES =====
function spawnEnemies() {
  if (Math.random()<0.02)
    enemies.push({ x:Math.random()*320,y:-40,w:40,h:40,hp:3,speed:2 });
}

function updateEnemies() {
  enemies.forEach((e,i)=>{
    e.y+=e.speed;

    bullets.forEach((b,j)=>{
      if(hit(b,e)){
        bullets.splice(j,1);
        e.hp--;
        if(e.hp<=0){
          enemies.splice(i,1);
          spawnCoins(e);
          daily.progress.kill5++;
          saveDaily();
        }
      }
    });
  });
}

// ===== COINS =====
function spawnCoins(e){
  coins.push({x:e.x+20,y:e.y,vy:2});
}

function updateCoins(){
  coins.forEach((c,i)=>{
    c.y+=c.vy;
    if(rectHit(player,{x:c.x,y:c.y,w:10,h:10})){
      money++;
      daily.progress.collect20++;
      coins.splice(i,1);
      saveDaily();
    }
  });
}

// ===== DRAW =====
function draw(){
  ctx.fillStyle="#0ff";
  ctx.fillRect(player.x,player.y,40,40);

  bullets.forEach(b=>{
    ctx.fillStyle="yellow";
    ctx.fillRect(b.x,b.y,4,10);
  });

  enemies.forEach(e=>{
    ctx.fillStyle="red";
    ctx.fillRect(e.x,e.y,e.w,e.h);
  });

  coins.forEach(c=>{
    ctx.fillStyle="gold";
    ctx.beginPath();
    ctx.arc(c.x,c.y,5,0,Math.PI*2);
    ctx.fill();
  });

  ctx.fillStyle="white";
  ctx.fillText("Coins: "+money,10,20);
}

// ===== SHOP =====
function buyDamage(){ if(money>=100){money-=100;player.damage++;}}
function buyFireRate(){ if(money>=150&&player.fireRate>3){money-=150;player.fireRate--;}}
function buyHP(){ if(money>=200){money-=200;player.hp++;}}

// ===== DAILY QUESTS =====
function renderQuests(){
  const q=document.getElementById("quests");
  q.innerHTML="<h3>ğŸ“… Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ</h3>";
  QUESTS.forEach(qs=>{
    let done=daily.completed[qs.id];
    q.innerHTML+=`
      <div class="quest">
        ${qs.text} (${daily.progress[qs.id]}/${qs.goal})
        ${done?"âœ…":`<button onclick="claim('${qs.id}')">ğŸ</button>`}
      </div>`;
  });
}

function claim(id){
  let q=QUESTS.find(x=>x.id===id);
  if(daily.progress[id]>=q.goal&&!daily.completed[id]){
    money+=q.reward;
    daily.completed[id]=true;
    saveDaily();
    renderQuests();
  }
}

function saveDaily(){
  localStorage.setItem("daily",JSON.stringify(daily));
  renderQuests();
}

// ===== COLLISION =====
function hit(b,e){return b.x>e.x&&b.x<e.x+e.w&&b.y>e.y&&b.y<e.y+e.h;}
function rectHit(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

loop();
</script>

</body>
</html>
